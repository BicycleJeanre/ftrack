<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account & Transaction Financial Simulation</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='-5' y='90' font-size='100'%3E%24%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <link rel="stylesheet" href="styles/simulation.css">
    <script src="https://cdn.jsdelivr.net/npm/decimal.js/decimal.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <!-- <script src="function/ajv7.min.js"></script> -->
</head>
<body>
    <div class="container">
        <!-- ...existing HTML content for panels and forms... -->
        <div class="input-section" id="panel-settings">
            <div class="panel-header" onclick="toggleAccordion('panel-settings')">
                <h2>Simulation Settings</h2>
                <span class="panel-arrow">&#9662;</span>
            </div>
            <div class="panel-content">
                <div class="desc">Choose how to run your simulation: by date range, by number of periods, or in timeless mode (just N periods, no dates).</div>
                <form id="settingsForm" class="form-inline">
                    <label for="mode">Mode</label>
                    <select id="mode">
                        <option value="daterange">Between Dates</option>
                        <option value="periods">Number of Periods</option>
                        <option value="timeless">Timeless (just N periods)</option>
                    </select>
                    <span id="dateFields">
                        <label for="start_date">Start Date</label>
                        <input type="date" id="start_date">
                        <label for="end_date">End Date</label>
                        <input type="date" id="end_date">
                    </span>
                    <span id="periodFields" style="display:none;">
                        <label for="period_count">Periods</label>
                        <input type="number" id="period_count" value="12" min="1" step="1">
                    </span>
                    <span id="periodTypeFields">
                        <label for="period_type">Period Type</label>
                        <select id="period_type">
                            <option value="day">Day</option>
                            <option value="week">Week (7 days, no break)</option>
                            <option value="week-break">Week (break on month)</option>
                            <option value="month">Month</option>
                            <option value="quarter">Quarter</option>
                            <option value="year">Year</option>
                        </select>
                    </span>
                    <button type="button" id="runSimulationBtn">Run Simulation</button>
                </form>
            </div>
        </div>
        <div class="input-section" id="panel-accounts">
            <div class="panel-header" onclick="toggleAccordion('panel-accounts')">
                <h2>Accounts</h2>
                <span class="panel-arrow">&#9662;</span>
            </div>
            <div class="panel-content">
                <div class="desc">Add one or more accounts. Each account can have a starting balance and an interest rate (applied each period).</div>
                <form id="accountForm" class="form-inline">
                    <label for="acct_name">Name</label>
                    <input type="text" id="acct_name" required placeholder="e.g. Checking">
                    <label for="acct_balance">Starting Balance</label>
                    <input type="number" id="acct_balance" required placeholder="e.g. 1000">
                    <button type="submit">Add/Update</button>
                </form>
                <div class="account-list">
                    <table id="accountsTable">
                        <thead>
                            <tr><th>Name</th><th>Start Balance</th><th>Interest %</th><th>Actions</th></tr>
                        </thead>
                        <tbody>
                            <!-- Account rows will be dynamically generated by JS. Each row should include an 'Add/Edit Interest' button in the Actions column. -->
                        </tbody>
                    </table>
                </div>
                <!-- Interest Settings Modal -->
                <div id="interestModal" class="modal" style="display:none;">
                    <div class="modal-content">
                        <span class="close" id="closeInterestModal">&times;</span>
                        <h3>Interest Settings</h3>
                        <form id="interestForm">
                            <label for="modal_acct_interest">Interest Rate</label>
                            <input type="number" id="modal_acct_interest" value="0" step="0.01" placeholder="e.g. 0.5">
                            <label for="modal_acct_interest_period">Interest Rate Period</label>
                            <select id="modal_acct_interest_period">
                                <option value="year">per Year</option>
                                <option value="quarter">per Quarter</option>
                                <option value="month">per Month</option>
                                <option value="week">per Week</option>
                                <option value="day">per Day</option>
                            </select>
                            <label for="modal_acct_compound_period">Compounding Period</label>
                            <select id="modal_acct_compound_period">
                                <option value="year">Yearly</option>
                                <option value="quarter">Quarterly</option>
                                <option value="month">Monthly</option>
                                <option value="week">Weekly</option>
                                <option value="day">Daily</option>
                            </select>
                            <label for="modal_acct_interest_type">Interest Type</label>
                            <select id="modal_acct_interest_type">
                                <option value="simple">Simple</option>
                                <option value="compound">Compound</option>
                            </select>
                            <div class="modal-actions">
                                <button type="button" id="saveInterestBtn">Save</button>
                                <button type="button" id="cancelInterestBtn">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="input-section" id="panel-transactions">
            <div class="panel-header" onclick="toggleAccordion('panel-transactions')">
                <h2>Transactions</h2>
                <span class="panel-arrow">&#9662;</span>
            </div>
            <div class="panel-content">
                <div class="desc">Add transactions. Each transaction affects an account, can be one-off or recurring, and can have a % change per period (e.g. salary increase, inflation, etc).<br>
                <b>Amount:</b> Positive for income, negative for expense.<br>
                <b>Date:</b> When the transaction first occurs.<br>
                <b>Recurring:</b> If checked, transaction repeats until end date.<br>
                <b>% Change/Period:</b> Applied to amount, account balance, or both (choose below).</div>
                <form id="transactionForm" class="form-inline">
                    <label for="txn_name">Name</label>
                    <input type="text" id="txn_name" required placeholder="e.g. Salary, Rent">
                    <label for="txn_account">Account</label>
                    <select id="txn_account"></select>
                    <label for="txn_amount">Amount</label>
                    <input type="number" id="txn_amount" required placeholder="e.g. 1000 or -500">
                    <label for="txn_date">Date</label>
                    <input type="date" id="txn_date" required>
                    <label for="txn_recurring">Recurring</label>
                    <input type="checkbox" id="txn_recurring">
                    <label for="txn_end_date">End Date</label>
                    <input type="date" id="txn_end_date">
                    <label for="txn_freq">Freq</label>
                    <select id="txn_freq">
                        <option value="month">Monthly</option>
                        <option value="day">Daily</option>
                    </select>
                    <label for="txn_pct_change">% Change/Period</label>
                    <input type="number" id="txn_pct_change" value="0" step="0.01" placeholder="e.g. 2">
                    <label for="txn_apply_to">Apply % to</label>
                    <select id="txn_apply_to">
                        <option value="amount">Amount</option>
                        <option value="balance">Balance</option>
                        <option value="both">Both</option>
                    </select>
                    <button type="submit">Add/Update</button>
                </form>
                <div class="transaction-list">
                    <table id="transactionsTable">
                        <thead>
                            <tr><th>Name</th><th>Account</th><th>Amount</th><th>Date</th><th>Recurring</th><th>End Date</th><th>Freq</th><th>% Change</th><th>Apply %</th><th>Actions</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="results-section" id="panel-results">
            <div class="panel-header" onclick="toggleAccordion('panel-results')">
                <h2>Results Table</h2>
                <span class="panel-arrow">&#9662;</span>
            </div>
            <div class="panel-content">
                <div id="resultsTableDiv"></div>
            </div>
        </div>
        <div class="chart-section" id="panel-chart">
            <div class="panel-header" onclick="toggleAccordion('panel-chart')">
                <h2>Account Balances Over Time</h2>
                <span class="panel-arrow">&#9662;</span>
            </div>
            <div class="panel-content">
                <div id="financialChart"></div>
            </div>
        </div>
        <div class="input-section" id="panel-calculator">
            <div class="panel-header" onclick="toggleAccordion('panel-calculator')">
                <h2>Financial Calculator</h2>
                <span class="panel-arrow">&#9662;</span>
            </div>
            <div class="panel-content">
                <div class="desc">Calculate compound interest, annuities, and more. Select a formula, enter values, and get instant results.</div>
                <form id="calculatorForm" class="form-inline">
                    <label for="calc_formula">Formula</label>
                    <select id="calc_formula">
                        <option value="compound-fv">Compound Interest (Future Value)</option>
                        <option value="compound-pv">Compound Interest (Present Value)</option>
                        <option value="annuity-fv">Future Value of Ordinary Annuity</option>
                        <option value="annuity-pv">Present Value of Ordinary Annuity</option>
                        <option value="annuity-due-fv">Future Value of Annuity Due</option>
                        <option value="annuity-due-pv">Present Value of Annuity Due</option>
                        <option value="perpetuity-pv">Perpetuity (Present Value)</option>
                        <option value="ear">Effective Annual Rate (EAR)</option>
                    </select>
                    <div id="calc-fields"></div>
                    <button type="submit">Calculate</button>
                </form>
                <div id="calc-result" class="calc-result"></div>
            </div>
        </div>
        <input type="file" id="importJsonInput" accept=".json" style="display:none;">
        <button type="button" onclick="document.getElementById('importJsonInput').click()">Import Simulation Data</button>
    </div>
    <script src="function/simulation.js"></script>
</body>
</html>
